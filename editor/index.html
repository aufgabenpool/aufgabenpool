<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,minimum-scale=1" />

        <link
            href="../node_modules/bootstrap/dist/css/bootstrap.css"
            rel="stylesheet"
            type="text/css"
        />

        <script src="../node_modules/axios/dist/axios.min.js"></script>

        <title>Aufgabenpool Editor</title>

        <style>
            body {
                background-color: #eeeeee;
            }
        </style>
    </head>

    <body>
        <br />

        <div class="container">
            <h1>Aufgabenpool Editor</h1>
            digiFellow Projekt
            <a href="https://aufgabenpool.th-koeln.de"
                >Digitaler Aufgabenpool Mathematik</a
            >

            <br /><br />

            <small>Moodle Username</small>
            <input
                class="form-control"
                type="text"
                id="username"
                name="username"
            />
            <small>Moodle Passwort</small>
            <input
                class="form-control"
                type="password"
                id="password"
                name="password"
            />

            <br />

            <button
                type="button"
                class="btn btn-sm btn-success"
                onclick="login();"
            >
                Login
            </button>
            <button
                type="button"
                class="btn btn-sm btn-danger"
                onclick="logout();"
            >
                Logout
            </button>

            <span id="login-info"></span>

            <br /><br />

            <div id="mainDiv" style="display: none">
                <div class="card border border-dark">
                    <div class="card-body">
                        <div id="taglist1"></div>
                    </div>
                </div>

                <br />

                <div class="card border border-dark">
                    <div class="card-body">
                        <div id="taglist2"></div>
                    </div>
                </div>

                <br />

                <div class="card border border-dark">
                    <div class="card-body">
                        <div id="taglist3"></div>
                    </div>
                </div>

                <br />

                <div class="card border border-dark">
                    <div class="card-body">
                        <h1>Kategorien</h1>
                        <div id="categories"></div>
                    </div>
                </div>

                <br />

                <div id="questionsStat"></div>

                <a id="questions-stat-anchor"></a>

                <div id="questions"></div>
            </div>

            <br />

            <small>
                Kontakt: Andreas Schwenk,
                <a href="mailto:andreas.schwenk@th-koeln.de"
                    >andreas.schwenk@th-koeln.de</a
                >, TH Köln
            </small>

            <br />
        </div>

        <script>
            function login() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                axios
                    .post('login', { username: username, password: password })
                    .then(function (response) {
                        //console.log(response.data);
                        document.getElementById('login-info').innerHTML =
                            response.data;
                        if (response.data === 'LOGIN OK') {
                            document.getElementById('login-info').innerHTML =
                                '';
                            document.getElementById('mainDiv').style.display =
                                'block';
                            showCategories();
                            showTaglists();
                            document.getElementById('password').value = '';
                        }
                    });
            }

            function logout() {
                axios.post('logout', {}).then(function (response) {
                    window.location = '.';
                });
            }

            function createTag(level) {
                const tagnameElement = document.getElementById(
                    'newtagname' + level,
                );
                axios
                    .post('createTag', {
                        level: level,
                        tagname: tagnameElement.value,
                    })
                    .then(function (response) {
                        showTaglists(true);
                        tagnameElement.value = '';
                    });
            }

            var topicTaglists = [[], [], []]; // [level1, leve2, level3]
            var srcTaglist = []; // list of institutions
            var tags = []; // all tags
            var categories = [];

            function showCategories() {
                axios.get('categories', {}).then(function (response) {
                    categories = response.data;
                    topCategories = [];
                    for (const category of categories) {
                        category.children = [];
                        for (const category2 of categories) {
                            if (category2.parent == category.id)
                                category.children.push(category2);
                        }
                        if (category.parent == 0) topCategories.push(category);
                    }
                    for (let i = 0; i < topCategories.length; i++)
                        topCategories[i] = topCategories[i].children[0];

                    const element = document.getElementById('categories');
                    let html = '<ul>';
                    for (const cat of topCategories) {
                        html += genCategory(cat);
                    }
                    html += '</ul>';
                    element.innerHTML = html;

                    //console.log(topCategories);
                });
            }

            function genCategory(cat) {
                let html = '<li>';
                html +=
                    '<span class="text-primary" style="cursor:pointer;" onclick="clickedCategory(' +
                    cat.id +
                    ",'" +
                    cat.name.replaceAll("'", '') +
                    '\')">' +
                    cat.name +
                    '</span>';
                if (cat.children.length > 0) {
                    html += '<ul>';
                    for (const child of cat.children)
                        html += genCategory(child);
                    html += '</ul>';
                }
                html += '</li>';
                return html;
            }

            function clickedCategory(catId, catName) {
                showQuestions(catId, catName);
                // jump to questions statistics anchor
                let url = window.location.href;
                location.href = '#questions-stat-anchor';
                window.scrollBy(0, -128);
                history.replaceState(null, null, url);
            }

            function showTaglists(_updateDropDownLists = false) {
                topicTaglists = [[], [], []];

                axios.post('taglist', {}).then(function (response) {
                    tags = response.data;
                    for (const tag of tags) {
                        if (tag.name.startsWith('te:1:'))
                            topicTaglists[0].push(tag);
                        else if (tag.name.startsWith('te:2:'))
                            topicTaglists[1].push(tag);
                        else if (tag.name.startsWith('te:3:'))
                            topicTaglists[2].push(tag);
                        else if (tag.name.startsWith('src:'))
                            srcTaglist.push(tag);
                        // all other tags are ignored
                    }
                    for (let level = 1; level <= 3; level++) {
                        const taglistDiv = document.getElementById(
                            'taglist' + level,
                        );
                        let html =
                            '<h1>Tags der Themengebietsebene ' +
                            level +
                            '</h1>';
                        for (const tag of topicTaglists[level - 1]) {
                            html += tag.rawname.substr(5) + ',&nbsp ';
                        }
                        html +=
                            `<br/><br/>
        <b>Neues Tag anlegen:</b>
        <input type="text" id="newtagname` +
                            level +
                            `" required>
        <button type="button" class="btn btn-sm btn-primary" onclick="createTag(` +
                            level +
                            `);">Anlegen</button>
        <br/><br/>
        <span class="text-primary">Achtung: Das Löschen/Ändern von Tags ist ausschließlich über Moodle möglich; bitte Rechtschreibung vor dem Anlegen genau prüfen!</span>
      `;
                        taglistDiv.innerHTML = html;
                    }

                    if (_updateDropDownLists) updateTagDropdownLists();
                });
            }

            const bloom = [
                'UNDEFINIERT',
                'Wissen',
                'Verständnis',
                'Anwendung',
                'Analyse',
                'Synthese',
                'Beurteilung',
            ];
            const maier = [
                [
                    'UNDEFINIERT',
                    'Fakten',
                    'Prozeduren',
                    'Konzepte',
                    'Metakognition',
                ],
                [
                    'UNDEFINIERT',
                    'Reproduktion',
                    'naher Transfer',
                    'weiter Transfer',
                    'Problemlösen',
                ],
                ['UNDEFINIERT', 'eine', 'bis zu 4', 'mehr als 4'],
                [
                    'UNDEFINIERT',
                    'definiert/konvergent',
                    'definiert/divergent',
                    'nicht definiert/divergent',
                ],
                ['UNDEFINIERT', 'kein', 'konstruiert', 'authentisch', 'real'],
                ['UNDEFINIERT', 'niedrig', 'mittel', 'hoch'],
                ['UNDEFINIERT', 'eine', 'Integration', 'Transformation'],
            ];
            const maierDim = [
                'Wissensart',
                'Kognitiver Prozess',
                'Wissenseinheiten',
                'Offenheit',
                'Lebensweltbezug',
                'Sprachliche Komplexität',
                'Repräsentationsformen',
            ];

            var questions = {};
            var displayedQuestionIDs = [];

            function showQuestions(categoryId, categoryName) {
                const questionsDiv = document.getElementById('questions');
                questionsDiv.innerHTML = '';
                axios
                    .post('questions', { categoryId: categoryId })
                    .then(function (response) {
                        //console.log(response.data);

                        displayedQuestionIDs = [];

                        let html = '';
                        questions = response.data;

                        let numQuestionsWithError = 0;

                        let questionIdx = 0;
                        for (const questionId in questions) {
                            const question = questions[questionId];

                            displayedQuestionIDs.push(questionId);

                            html += '<br/>';
                            html += '<div class="card border border-dark">';
                            html += '<div class="card-body">';

                            html += '<h2>' + question.name + '</h2>';

                            // TODO: moodle link url MUST include correct course number!!
                            let courseId = 2;

                            html +=
                                'Moodle-ID: ' +
                                questionId +
                                ' <a href="https://aufgabenpool.th-koeln.de/moodle/question/bank/editquestion/question.php?returnurl=%2Fquestion%2Fedit.php%3Fcourseid%3D2&courseid=' +
                                courseId +
                                '&id=' +
                                questionId +
                                '" target="_blank">Moodle-Link</a>' +
                                '<br/>';

                            html += '<hr/>';
                            html += '<div class="col text-center">';
                            html +=
                                '  <img class="" src="https://aufgabenpool.th-koeln.de/data/' +
                                questionId +
                                '_0.png" alt="VORSCHAU NOCH NICHT AUTOMATISCH ERSTELLT (BITTE WARTEN!)"></img>';
                            html += '</div>';
                            html += '<hr/>';

                            // dropdown
                            html +=
                                `<b>TE1:</b>&nbsp; <span id="question_` +
                                questionId +
                                `_te1">UNDEFINIERT</span>&nbsp;&nbsp;`;
                            html += '&bull;&nbsp;';
                            html +=
                                `<b>TE2:</b>&nbsp; <span id="question_` +
                                questionId +
                                `_te2">UNDEFINIERT</span>&nbsp;&nbsp;`;
                            html += '&bull;&nbsp;';
                            html +=
                                `<b>TE3a:</b>&nbsp; <span id="question_` +
                                questionId +
                                `_te3a">UNDEFINIERT</span>&nbsp;&nbsp;`;
                            html +=
                                `<b>TE3b:</b>&nbsp; <span id="question_` +
                                questionId +
                                `_te3b">UNDEFINIERT</span>&nbsp;&nbsp;`;
                            html +=
                                `<b>TE3c:</b>&nbsp; <span id="question_` +
                                questionId +
                                `_te3c">UNDEFINIERT</span>&nbsp;&nbsp;`;
                            html +=
                                `<b>TE3d:</b>&nbsp; <span id="question_` +
                                questionId +
                                `_te3d">UNDEFINIERT</span>&nbsp;&nbsp;`;

                            html += '<br/><br/>';

                            html += '<div class="col">';

                            let levelStrList = [
                                '1',
                                '2',
                                '3a',
                                '3b',
                                '3c',
                                '3d',
                            ];

                            for (let level = 0; level < 6; level++) {
                                let levelStr = levelStrList[level];
                                html +=
                                    `
          <div class="dropdown" style="display:inline-block">
            <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="dropdown_menu_` +
                                    questionId +
                                    `_te` +
                                    level +
                                    `" data-bs-toggle="dropdown" aria-expanded="false">
              TE` +
                                    levelStr +
                                    ` auswählen
            </button>
            <ul class="dropdown-menu" id="dropdown_menu_list_` +
                                    questionId +
                                    `_te` +
                                    level +
                                    `" style="max-height: 50vh; overflow-y: scroll; cursor: pointer;">
            </ul>
          </div>`;
                                if (level < 2) html += '&nbsp;&bull;';
                            }
                            html += '</div>';

                            html += '<br/>';

                            // source (unversity, institution, ...)
                            html +=
                                `<b>Herkunft:</b>&nbsp; <span id="question_` +
                                questionId +
                                `_src">UNDEFINIERT</span>&nbsp;&nbsp;`;

                            html += '<br/><br/>';

                            html +=
                                `
        <div class="dropdown" style="display:inline-block">
          <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="dropdown_menu_` +
                                questionId +
                                `_src" data-bs-toggle="dropdown" aria-expanded="false">
            Herkunft auswählen
          </button>
          <ul class="dropdown-menu" id="dropdown_menu_list_` +
                                questionId +
                                `_src" style="max-height: 50vh; overflow-y: scoll; cursor: pointer;">
          </ul>
        </div>`;

                            html += '<br/><br/>';

                            // tags bloom
                            html += '<b>Bloom:</b>&nbsp;&nbsp;&nbsp; ';
                            for (let i = 0; i < bloom.length; i++) {
                                html += `
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="_NAME_" id="_ID_">
            <label class="form-check-label" for="_ID_">_TITLE_</label>
          </div>`
                                    .replaceAll('_TITLE_', bloom[i])
                                    .replaceAll(
                                        '_NAME_',
                                        '_bloom_' + questionId,
                                    )
                                    .replaceAll(
                                        '_ID_',
                                        '_bloom_' + questionId + '_' + i,
                                    );
                            }

                            html += '<br/><br/>';

                            // tags Maier
                            for (let j = 0; j < maierDim.length; j++) {
                                html +=
                                    '<b>Maier ' +
                                    maierDim[j] +
                                    ':</b>&nbsp;&nbsp;&nbsp; ';
                                for (let i = 0; i < maier[j].length; i++) {
                                    html += `
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="_NAME_" id="_ID_">
              <label class="form-check-label" for="_ID_">_TITLE_</label>
            </div>`
                                        .replaceAll('_TITLE_', maier[j][i])
                                        .replaceAll(
                                            '_NAME',
                                            '_maier_' + j + '_' + questionId,
                                        )
                                        .replaceAll(
                                            '_ID_',
                                            '_maier_' +
                                                j +
                                                '_' +
                                                questionId +
                                                '_' +
                                                i,
                                        );
                                }
                                html += '<br/>';
                            }

                            html += '<br/>';

                            // QS
                            html +=
                                '<b>Qualitätsgesichert/geprüft:</b> &nbsp;&nbsp;';
                            const qsNames = [
                                'visuell',
                                'sprachlich',
                                'inhaltlich',
                                'Tagging',
                                'Import Ilias',
                                'Import Moodle',
                            ];
                            const qsIds = [
                                'qsVisuell',
                                'qsSprachlich',
                                'qsInhaltlich',
                                'qsTagging',
                                'qsImportIlias',
                                'qsImportMoodle',
                            ];
                            for (let i = 0; i < qsNames.length; i++) {
                                html +=
                                    `
        <div class="form-check form-check-inline">
          <label class="form-check-label">` +
                                    qsNames[i] +
                                    `&nbsp;</label>
          <input class="form-check-input" type="checkbox" id="question_` +
                                    questionId +
                                    `_` +
                                    qsIds[i] +
                                    `">
        </div>`;
                            }

                            html += '<br/>';
                            html += '<br/>';

                            // misc

                            html += '<b>Sonstiges:</b> &nbsp;&nbsp;';

                            html +=
                                `
        <div class="form-check form-check-inline">
          <label class="form-check-label">Aufgabe gesperrt&nbsp;</label>
          <input class="form-check-input" type="checkbox" id="question_` +
                                questionId +
                                `_hidden">
        </div>`;

                            html += '&nbsp;&nbsp;';

                            html +=
                                `
        <div class="form-check form-check-inline">
          <label class="form-check-label">Aufgabe praxiserprobt&nbsp;</label>
          <input class="form-check-input" type="checkbox" id="question_` +
                                questionId +
                                `_testedInPractice">
        </div>`;

                            html += '&nbsp;&nbsp;';

                            html +=
                                `
        <div class="form-check form-check-inline">
          <label class="form-check-label">Fehler beim Import in Ilias (DIESES TAG WIRD SPÄTER ENTFERNT!)&nbsp;</label>
          <input class="form-check-input" type="checkbox" id="question_` +
                                questionId +
                                `_iliasImportError">
        </div>`;

                            html += '<br/>';
                            html += '<br/>';

                            // debug and save button
                            html +=
                                '<button type="button" class="btn btn-sm btn-danger" onclick="saveChanges(true, ' +
                                questionId +
                                ')">Debug</button>';
                            html += '&nbsp;';
                            html +=
                                '<button type="button" class="btn btn-primary" onclick="saveChanges(false, ' +
                                questionId +
                                ')">Änderungen speichern</button>';
                            html +=
                                '&nbsp; <b>Status:</b> <span id="question_' +
                                questionId +
                                '_status">OK</span>';

                            html += '</div></div>'; // end card

                            questionIdx++;
                            if (questionIdx > 200) {
                                html +=
                                    'MEHR ALS 200 FRAGEN. ANZEIGE STOPPT. BITTE AUSWAHL EINSCHRÄNKEN!';
                                break;
                            }
                        } // for all questions

                        // set HTML
                        questionsDiv.innerHTML = html;

                        // select tags
                        for (const questionId of displayedQuestionIDs) {
                            const question = questions[questionId];

                            let statusMsg = '';
                            let error = false;

                            let te1 = [];
                            let te2 = [];
                            let te3 = [];
                            let src = '';
                            let bloom = 0;
                            let maier = [0, 0, 0, 0, 0, 0, 0];
                            let hidden = false;
                            let iliasImportError = false;
                            let practiceTested = false;

                            let qsVisuell = false;
                            let qsSprachlich = false;
                            let qsInhaltlich = false;
                            let qsTagging = false;
                            let qsImportIlias = false;
                            let qsImportMoodle = false;

                            for (const tagId in question.tags) {
                                const tag = question.tags[tagId];
                                if (tag.name.startsWith('te:1:')) te1.push(tag);
                                else if (tag.name.startsWith('te:2:'))
                                    te2.push(tag);
                                else if (tag.name.startsWith('te:3:'))
                                    te3.push(tag);
                                else if (tag.name.startsWith('src:'))
                                    src = tag.rawname;
                                else if (tag.name.startsWith('bloom:'))
                                    bloom = parseInt(tag.name.substr(6));
                                else if (tag.name.startsWith('maier:1:'))
                                    maier[0] = parseInt(tag.name.substr(8));
                                else if (tag.name.startsWith('maier:2:'))
                                    maier[1] = parseInt(tag.name.substr(8));
                                else if (tag.name.startsWith('maier:3:'))
                                    maier[2] = parseInt(tag.name.substr(8));
                                else if (tag.name.startsWith('maier:4:'))
                                    maier[3] = parseInt(tag.name.substr(8));
                                else if (tag.name.startsWith('maier:5:'))
                                    maier[4] = parseInt(tag.name.substr(8));
                                else if (tag.name.startsWith('maier:6:'))
                                    maier[5] = parseInt(tag.name.substr(8));
                                else if (tag.name.startsWith('maier:7:'))
                                    maier[6] = parseInt(tag.name.substr(8));
                                else if (tag.name === 'hidden') hidden = true;
                                else if (tag.name === 'praxiserprobt')
                                    practiceTested = true;
                                else if (tag.name === 'ilias-import-error')
                                    iliasImportError = true;
                                else if (tag.name === 'qs:visuellgeprueft')
                                    qsVisuell = true;
                                else if (tag.name === 'qs:sprachlichgeprueft')
                                    qsSprachlich = true;
                                else if (tag.name === 'qs:inhaltlichgeprueft')
                                    qsInhaltlich = true;
                                else if (tag.name === 'qs:tagginggeprueft')
                                    qsTagging = true;
                                else if (tag.name === 'qs:importiliasgeprueft')
                                    qsImportIlias = true;
                                else if (tag.name === 'qs:importmoodlegeprueft')
                                    qsImportMoodle = true;
                                else {
                                    error = true;
                                    statusMsg +=
                                        'Unbekanntes Tag "' + tag.name + '"! ';
                                }
                            }

                            if (bloom < 1 || bloom > 6) {
                                error = true;
                                statusMsg += 'Bloom ungültig! ';
                            }
                            if (maier[0] < 1 || maier[0] > 4) {
                                error = true;
                                statusMsg += 'Maier "Wissensart" ungültig! ';
                            }
                            if (maier[1] < 1 || maier[1] > 4) {
                                error = true;
                                statusMsg +=
                                    'Maier "Kognitiver Prozess" ungültig! ';
                            }
                            if (maier[2] < 1 || maier[2] > 3) {
                                error = true;
                                statusMsg +=
                                    'Maier "Wissenseinheiten" ungültig! ';
                            }
                            if (maier[3] < 1 || maier[3] > 3) {
                                error = true;
                                statusMsg += 'Maier "Offenheit" ungültig! ';
                            }
                            if (maier[4] < 1 || maier[4] > 4) {
                                error = true;
                                statusMsg +=
                                    'Maier "Lebensweltbezug" ungültig! ';
                            }
                            if (maier[5] < 1 || maier[5] > 3) {
                                error = true;
                                statusMsg +=
                                    'Maier "Sprachliche Komplexität" ungültig! ';
                            }
                            if (maier[6] < 1 || maier[6] > 3) {
                                error = true;
                                statusMsg +=
                                    'Maier "Repräsentationsformen" ungültig! ';
                            }

                            if (te1.length == 0) {
                                error = true;
                                statusMsg += 'TE1 fehlt! ';
                            }
                            if (te2.length == 0) {
                                error = true;
                                statusMsg += 'TE2 fehlt! ';
                            }
                            if (te3.length == 0) {
                                error = true;
                                statusMsg += 'TE3 fehlt! ';
                            }

                            if (te1.length > 1) {
                                error = true;
                                statusMsg +=
                                    'Zu viele TE1! (Bitte auch TE2, TE3 anpassen!)';
                            }
                            if (te2.length > 1) {
                                error = true;
                                statusMsg +=
                                    'Zu viele TE2! (Bitte auch TE3 anpassen!)';
                            }
                            if (te3.length > 4) {
                                error = true;
                                statusMsg += 'Zu viele TE3! (maximal 4)';
                            }

                            if (src.length == 0) {
                                error = true;
                                statusMsg += 'Herkunftstag fehlt! ';
                            }

                            let te1_str = '';
                            for (let i = 0; i < te1.length; i++) {
                                if (i > 0)
                                    te1_str +=
                                        ' <span class="text-danger">UND</span> ';
                                te1_str += te1[i].rawname.substr(5);
                            }
                            document.getElementById(
                                'question_' + questionId + '_te1',
                            ).innerHTML = te1_str;

                            let te2_str = '';
                            for (let i = 0; i < te2.length; i++) {
                                if (i > 0)
                                    te2_str +=
                                        ' <span class="text-danger">UND</span> ';
                                te2_str += te2[i].rawname.substr(5);
                            }
                            document.getElementById(
                                'question_' + questionId + '_te2',
                            ).innerHTML = te2_str;

                            let te3_str = '';
                            if (te3.length >= 1)
                                te3_str = te3[0].rawname.substr(5);
                            document.getElementById(
                                'question_' + questionId + '_te3a',
                            ).innerHTML = te3_str;

                            te3_str = '';
                            if (te3.length >= 2)
                                te3_str = te3[1].rawname.substr(5);
                            document.getElementById(
                                'question_' + questionId + '_te3b',
                            ).innerHTML = te3_str;

                            te3_str = '';
                            if (te3.length >= 3)
                                te3_str = te3[2].rawname.substr(5);
                            document.getElementById(
                                'question_' + questionId + '_te3c',
                            ).innerHTML = te3_str;

                            te3_str = '';
                            if (te3.length >= 4)
                                te3_str = te3[3].rawname.substr(5);
                            document.getElementById(
                                'question_' + questionId + '_te3d',
                            ).innerHTML = te3_str;

                            document.getElementById(
                                'question_' + questionId + '_src',
                            ).innerHTML = src.substr(4);

                            document.getElementById(
                                '_bloom_' + questionId + '_' + bloom,
                            ).checked = true;
                            for (let i = 0; i < maier.length; i++)
                                document.getElementById(
                                    '_maier_' +
                                        i +
                                        '_' +
                                        questionId +
                                        '_' +
                                        maier[i],
                                ).checked = true;

                            document.getElementById(
                                'question_' + questionId + '_testedInPractice',
                            ).checked = practiceTested;
                            document.getElementById(
                                'question_' + questionId + '_hidden',
                            ).checked = hidden;
                            document.getElementById(
                                'question_' + questionId + '_iliasImportError',
                            ).checked = iliasImportError;

                            document.getElementById(
                                'question_' + questionId + '_qsVisuell',
                            ).checked = qsVisuell;
                            document.getElementById(
                                'question_' + questionId + '_qsSprachlich',
                            ).checked = qsSprachlich;
                            document.getElementById(
                                'question_' + questionId + '_qsInhaltlich',
                            ).checked = qsInhaltlich;
                            document.getElementById(
                                'question_' + questionId + '_qsTagging',
                            ).checked = qsTagging;
                            document.getElementById(
                                'question_' + questionId + '_qsImportIlias',
                            ).checked = qsImportIlias;
                            document.getElementById(
                                'question_' + questionId + '_qsImportMoodle',
                            ).checked = qsImportMoodle;

                            //if(practiceTested) console.log(question.name); // TODO: TEST!!!!!

                            if (error)
                                document.getElementById(
                                    'question_' + questionId + '_status',
                                ).innerHTML =
                                    '<span class="text-danger">FEHLER: ' +
                                    statusMsg +
                                    '</span>';
                            else
                                document.getElementById(
                                    'question_' + questionId + '_status',
                                ).innerHTML =
                                    '<span class="text-success">OK</span>';

                            if (error) numQuestionsWithError++;
                        } // for all questions

                        updateTagDropdownLists();

                        // show statistics of shown questions
                        let element = document.getElementById('questionsStat');
                        element.innerHTML =
                            '<p class="h2 text-secondary text-center">Aktuelle Kategorie: ' +
                            categoryName +
                            '<br/>Anzahl ausgewählter Fragen: ' +
                            displayedQuestionIDs.length +
                            '<br/>Anzahl Fragen mit Handlungsbedarf: ' +
                            numQuestionsWithError +
                            '</p>';
                    });
            }

            function updateTagDropdownLists() {
                for (const questionId of displayedQuestionIDs) {
                    const question = questions[questionId];
                    // topic dropdown lists
                    for (let level = 0; level < 6; level++) {
                        let element = document.getElementById(
                            'dropdown_menu_list_' + questionId + '_te' + level,
                        );
                        let html = '';
                        html +=
                            '<li><a class="dropdown-item" onclick="updateTopicTag(' +
                            questionId +
                            ',' +
                            level +
                            ',' +
                            -1 +
                            ');">' +
                            '<i>ZURÜCKSETZEN</i>' +
                            '</a></li>';
                        for (const tag of topicTaglists[
                            level > 2 ? 2 : level
                        ]) {
                            html +=
                                '<li><a class="dropdown-item" onclick="updateTopicTag(' +
                                questionId +
                                ',' +
                                level +
                                ',' +
                                tag.id +
                                ');">' +
                                tag.rawname.substr(5) +
                                '</a></li>';
                        }
                        element.innerHTML = html;
                    }
                    // source (institution) dropdown lists
                    let element = document.getElementById(
                        'dropdown_menu_list_' + questionId + '_src',
                    );
                    let html = '';
                    for (const tag of srcTaglist) {
                        html +=
                            '<li><a class="dropdown-item" onclick="updateSourceTag(' +
                            questionId +
                            ',' +
                            tag.id +
                            ');">' +
                            tag.rawname.substr(4) +
                            '</a></li>';
                    }
                    element.innerHTML = html;
                }
            }

            function updateTopicTag(questionId, level, tagId) {
                //console.log(level + ',' + tagId);

                let teIdList = ['1', '2', '3a', '3b', '3c', '3d'];

                let element = document.getElementById(
                    'question_' + questionId + '_te' + teIdList[level],
                );
                element.innerHTML = '';
                for (const tag of topicTaglists[level > 2 ? 2 : level]) {
                    if (tag.id == tagId) {
                        //console.log(tag.name);
                        element.innerHTML = tag.rawname.substring(5);
                    }
                }
            }

            function updateSourceTag(questionId, tagId) {
                let element = document.getElementById(
                    'question_' + questionId + '_src',
                );
                for (const tag of srcTaglist) {
                    if (tag.id === tagId)
                        element.innerHTML = tag.rawname.substring(4);
                }
            }

            function saveChanges(debug, questionId) {
                // if debug is true, no changes are made to the DB

                let questionTags = []; // tags as list of strings
                let questionTagIds = []; // tags as list of IDs

                // topic levels
                let teList = ['1', '2', '3a', '3b', '3c', '3d'];
                for (let i = 0; i < teList.length; i++) {
                    let te = document.getElementById(
                        'question_' + questionId + '_te' + teList[i],
                    ).innerHTML;
                    if (te.length > 0) {
                        te = 'te:' + teList[i][0] + ':' + te.toLowerCase();
                        questionTags.push(te);
                    }
                }

                // source
                let src = document.getElementById(
                    'question_' + questionId + '_src',
                ).innerHTML;
                if (src.length > 0) {
                    src = 'src:' + src.toLowerCase();
                    questionTags.push(src);
                }

                // Bloom
                for (let i = 1; i < bloom.length; i++) {
                    // skip first (index 0)
                    let element = document.getElementById(
                        '_bloom_' + questionId + '_' + i,
                    );
                    if (element.checked) questionTags.push('bloom:' + i);
                }

                // Maier
                for (let j = 0; j < maier.length; j++) {
                    for (let i = 1; i < maier[j].length; i++) {
                        let element = document.getElementById(
                            '_maier_' + j + '_' + questionId + '_' + i,
                        );
                        if (element.checked)
                            questionTags.push('maier:' + (j + 1) + ':' + i);
                    }
                }

                // Misc (hidden, practice, iliasImportError)
                let element = document.getElementById(
                    'question_' + questionId + '_hidden',
                );
                if (element.checked) questionTags.push('hidden');

                element = document.getElementById(
                    'question_' + questionId + '_testedInPractice',
                );
                if (element.checked) questionTags.push('praxiserprobt');

                element = document.getElementById(
                    'question_' + questionId + '_iliasImportError',
                );
                if (element.checked) questionTags.push('ilias-import-error');

                // QS
                element = document.getElementById(
                    'question_' + questionId + '_qsVisuell',
                );
                if (element.checked) questionTags.push('qs:visuellgeprueft');
                element = document.getElementById(
                    'question_' + questionId + '_qsSprachlich',
                );
                if (element.checked) questionTags.push('qs:sprachlichgeprueft');
                element = document.getElementById(
                    'question_' + questionId + '_qsInhaltlich',
                );
                if (element.checked) questionTags.push('qs:inhaltlichgeprueft');
                element = document.getElementById(
                    'question_' + questionId + '_qsTagging',
                );
                if (element.checked) questionTags.push('qs:tagginggeprueft');
                element = document.getElementById(
                    'question_' + questionId + '_qsImportIlias',
                );
                if (element.checked)
                    questionTags.push('qs:importiliasgeprueft');
                element = document.getElementById(
                    'question_' + questionId + '_qsImportMoodle',
                );
                if (element.checked)
                    questionTags.push('qs:importmoodlegeprueft');

                // get tag Ids (...slow implementation)
                console.log('-----');
                console.log(tags);
                for (let k = 0; k < questionTags.length; k++) {
                    for (let i = 0; i < tags.length; i++) {
                        if (tags[i].name === questionTags[k])
                            questionTagIds.push(tags[i].id);
                    }
                }

                // status
                element = document.getElementById(
                    'question_' + questionId + '_status',
                );
                element.innerHTML =
                    '<span class="text-primary">... wird beim erneuten Klick auf die Kategorie überprüft und angezeigt (TODO: sofort tun...).</span>';

                // debug output to DOM
                if (debug) {
                    element.innerHTML +=
                        '<br/><span class="text-danger">Neue Tags: { ' +
                        questionTags.join(', ') +
                        ' }.</span>';
                    element.innerHTML +=
                        '<span class="text-danger">&nbsp;Datenbank IDs: { ' +
                        questionTagIds.join(', ') +
                        ' }.</span>';
                }

                // debug output to console
                if (debug) {
                    console.log('save ' + questionId);
                    console.log(questionTags);
                    console.log(questionTagIds);
                    console.log(questions[questionId]);
                    console.log(tags);
                }

                // write to database
                if (debug == false) {
                    axios
                        .post('writeTags', {
                            questionId: questionId,
                            questionTagIds: questionTagIds,
                        })
                        .then(function (response) {
                            console.log(response.data);
                        });
                }
            }
        </script>

        <script
            src="../node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"
            type="text/javascript"
        ></script>
    </body>
</html>
